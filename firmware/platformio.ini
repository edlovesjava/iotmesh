; PlatformIO Project Configuration
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = pir, led, button, dht, watcher, gateway, clock, light, remote
src_dir = nodes
lib_dir = lib
include_dir = include

; ============================================================
; Common settings for all ESP32 nodes
; ============================================================
[env]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600

; Partition scheme for OTA
board_build.partitions = min_spiffs.csv

; Library dependency finder mode
lib_ldf_mode = deep+

; Common libraries
lib_deps =
    painlessmesh/painlessMesh @ ^1.5.0
    bblanchon/ArduinoJson @ ^7.0.0
    adafruit/Adafruit SSD1306 @ ^2.5.0
    adafruit/Adafruit GFX Library @ ^1.11.0
    ; MeshSwarm from local symlink (for development)
    ; To revert to GitHub: https://github.com/edlovesjava/MeshSwarm.git
    symlink://../MeshSwarm

; Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=0
    -DARDUINO_ARCH_ESP32

; ============================================================
; Node-specific environments
; ============================================================

[env:pir]
build_src_filter = +<pir/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"pir\"
    -DNODE_NAME=\"PIR\"
    -DENABLE_PIR_SENSOR

[env:led]
build_src_filter = +<led/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"led\"
    -DNODE_NAME=\"LED\"
    -DENABLE_LED_OUTPUT

[env:button]
build_src_filter = +<button/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"button\"
    -DNODE_NAME=\"Button\"
    -DENABLE_BUTTON_INPUT

[env:button2]
build_src_filter = +<button/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"button2\"
    -DNODE_NAME=\"Button2\"
    -DENABLE_BUTTON_INPUT
    -DBUTTON_PIN=4

[env:dht]
build_src_filter = +<dht/>
lib_deps =
    ${env.lib_deps}
    adafruit/DHT sensor library @ ^1.4.0
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"dht\"
    -DNODE_NAME=\"DHTNode\"
    -DENABLE_DHT_SENSOR

[env:watcher]
build_src_filter = +<watcher/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"watcher\"
    -DNODE_NAME=\"Watcher\"

[env:clock]
build_src_filter = +<clock/>
lib_deps =
    ${env.lib_deps}
    diyables/DIYables TFT Round @ ^1.0.1
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"clock\"
    -DNODE_NAME=\"Clock\"
    -DMESHSWARM_ENABLE_DISPLAY=0
    ; Timezone: EST = UTC-5 = -18000 seconds
    -DGMT_OFFSET_SEC=-18000
    -DDAYLIGHT_OFFSET=3600

[env:light]
build_src_filter = +<light/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"light\"
    -DNODE_NAME=\"Light\"
    -DLIGHT_SENSOR_LDR

[env:gateway]
build_src_filter = +<gateway/>
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"gateway\"
    -DNODE_NAME=\"Gateway\"
    -DENABLE_GATEWAY_MODE
    -DENABLE_TELEMETRY
    -DENABLE_OTA_DISTRIBUTION
    -DMESHSWARM_ENABLE_HTTP_SERVER=1

[env:remote]
build_src_filter = +<remote/>
lib_deps =
    ${env.lib_deps}
    bodmer/TFT_eSPI @ ^2.5.43
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"remote\"
    -DNODE_NAME=\"Remote\"
    -DMESHSWARM_ENABLE_DISPLAY=0
    ; TFT_eSPI configuration for ESP32-2432S028R (Cheap Yellow Display)
    -DUSER_SETUP_LOADED=1
    -DILI9341_DRIVER=1
    -DTFT_WIDTH=320
    -DTFT_HEIGHT=240
    ; Display pins
    -DTFT_MISO=12
    -DTFT_MOSI=13
    -DTFT_SCLK=14
    -DTFT_CS=15
    -DTFT_DC=2
    -DTFT_RST=-1
    -DTFT_BL=21
    -DTFT_BACKLIGHT_ON=HIGH
    ; Touch pins
    -DTOUCH_CS=33
    ; Font support
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    ; SPI speed
    -DSPI_FREQUENCY=40000000
    -DSPI_READ_FREQUENCY=20000000

; ============================================================
; Development variants
; ============================================================

[env:pir_debug]
extends = env:pir
build_type = debug
build_flags =
    ${env:pir.build_flags}
    -DCORE_DEBUG_LEVEL=4
    -DMESHSWARM_LOG_LEVEL=4

; ============================================================
; Hardware variants (ESP32-S3)
; ============================================================

[env:pir_s3]
extends = env:pir
board = esp32-s3-devkitc-1
build_flags =
    ${env:pir.build_flags}
    -DBOARD_ESP32S3

[env:gateway_s3]
extends = env:gateway
board = esp32-s3-devkitc-1

[env:touch169]
build_src_filter = +<touch169/>
board = esp32-s3-devkitc-1
; Enable USB CDC for serial output on native USB
board_upload.use_1200bps_touch = false
board_upload.wait_for_upload_port = false
lib_deps =
    ${env.lib_deps}
    bodmer/TFT_eSPI @ ^2.5.43
build_flags =
    ${env.build_flags}
    -DNODE_TYPE=\"touch169\"
    -DNODE_NAME=\"Touch169\"
    -DMESHSWARM_ENABLE_DISPLAY=0
    -DBOARD_ESP32S3
    ; USB CDC for serial monitor
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; Timezone: EST = UTC-5 = -18000 seconds
    -DGMT_OFFSET_SEC=-18000
    -DDAYLIGHT_OFFSET=3600
    ; TFT_eSPI configuration for Waveshare ESP32-S3-Touch-LCD-1.69
    ; Pin config from official Waveshare demo code
    -DUSER_SETUP_LOADED=1
    -DST7789_DRIVER=1
    -DTFT_WIDTH=240
    -DTFT_HEIGHT=280
    ; ESP32-S3 requires HSPI port (VSPI reserved for flash/PSRAM)
    -DUSE_HSPI_PORT=1
    ; Display pins (ST7789V2) - from Waveshare pin_config.h
    -DTFT_MOSI=7
    -DTFT_SCLK=6
    -DTFT_CS=5
    -DTFT_DC=4
    -DTFT_RST=8
    -DTFT_BL=15
    -DTFT_BACKLIGHT_ON=HIGH
    ; No separate MISO for this display
    -DTFT_MISO=-1
    ; I2C pins for touch/IMU/RTC
    -DTOUCH_SDA=11
    -DTOUCH_SCL=10
    ; Font support
    -DLOAD_GLCD=1
    -DLOAD_FONT2=1
    -DLOAD_FONT4=1
    -DLOAD_FONT6=1
    -DLOAD_FONT7=1
    -DLOAD_FONT8=1
    -DLOAD_GFXFF=1
    -DSMOOTH_FONT=1
    ; SPI speed (27MHz more stable for S3)
    -DSPI_FREQUENCY=27000000
    ; in case this is a newer board verrsion
    -DUSE_NEW_PIN_CONFIG=1
